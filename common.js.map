{"version":3,"file":"common.js","mappings":"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","sources":["./apps/concierge/src/app/desks/desks-state.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { MatDialog } from '@angular/material/dialog';\nimport { listChildMetadata, showMetadata } from '@placeos/ts-client';\nimport { BehaviorSubject, combineLatest, Observable, of, Subject } from 'rxjs';\nimport {\n    catchError,\n    debounceTime,\n    distinctUntilChanged,\n    map,\n    scan,\n    shareReplay,\n    switchMap,\n    tap,\n} from 'rxjs/operators';\nimport { endOfDay, format, getUnixTime, startOfDay } from 'date-fns';\n\nimport {\n    approveBooking,\n    Booking,\n    checkinBooking,\n    queryPagedBookings,\n    rejectBooking,\n    saveBooking,\n} from '@placeos/bookings';\nimport {\n    AsyncHandler,\n    notifyError,\n    notifyInfo,\n    notifySuccess,\n    openConfirmModal,\n    SettingsService,\n} from '@placeos/common';\nimport { Desk, OrganisationService } from '@placeos/organisation';\n\nimport { generateQRCode } from 'libs/common/src/lib/qr-code';\nimport { QueryResponse } from '@placeos/ts-client/dist/esm/resources/functions';\n\nfunction addQRCodeToBooking(booking: Booking): Booking {\n    return new Booking({\n        ...booking,\n        extension_data: {\n            ...booking.extension_data,\n            checkin_qr_code: generateQRCode(\n                `/workplace/#/book/code?asset_id=${encodeURIComponent(\n                    booking.asset_id\n                )}`\n            ),\n        },\n    });\n}\n\nexport interface DeskFilters {\n    date?: number;\n    zones?: string[];\n    show_map?: boolean;\n    search?: string;\n}\n\n@Injectable({\n    providedIn: 'root',\n})\nexport class DesksStateService extends AsyncHandler {\n    private _filters = new BehaviorSubject<DeskFilters>({});\n    private _new_desks = new BehaviorSubject<Desk[]>([]);\n    private _desk_bookings: Booking[] = [];\n    private _loading = new BehaviorSubject<boolean>(false);\n\n    public readonly new_desks = this._new_desks.asObservable();\n\n    public get new_desk_count() {\n        return this._new_desks.getValue()?.length || 0;\n    }\n\n    public readonly loading = this._loading.asObservable();\n\n    public readonly filters = this._filters.asObservable();\n\n    public readonly desks: Observable<Desk[]> = this._filters.pipe(\n        debounceTime(500),\n        switchMap((filters) => {\n            const zones = filters.zones || [];\n            return zones && !zones.includes('All')\n                ? showMetadata(zones[0], 'desks').pipe(\n                      map((m) => (m.details instanceof Array ? m.details : [])),\n                      catchError((_) => of([]))\n                  )\n                : listChildMetadata(this._org.building?.id, {\n                      name: 'desks',\n                  }).pipe(\n                      map((m) =>\n                          m\n                              .map((i) => i.metadata?.desks?.details || [])\n                              .reduce((c: any[], i: any[]) => [...c, ...i], [])\n                      ),\n                      catchError((_) => of([]))\n                  );\n        }),\n        map((list) => {\n            if (!(list instanceof Array)) list = [];\n            list.sort((a, b) => a.name?.localeCompare(b.name));\n            return list.map((i) => new Desk({ ...i, qr_code: '' }));\n        }),\n        shareReplay(1)\n    );\n\n    private _next_page = new Subject<() => QueryResponse<Booking>>();\n    private _call_next_page = new Subject<string>();\n    private _all_zones_keys = ['All', -1, '-1'];\n    public readonly setup_paging = combineLatest([\n        this._filters,\n        this._org.initialised,\n    ]).pipe(\n        debounceTime(500),\n        tap(([filters, loaded]) => {\n            if (!loaded) return;\n            const date = filters.date || Date.now();\n            const zones =\n                !filters.zones ||\n                filters.zones.some((z) => this._all_zones_keys.includes(z))\n                    ? this._settings.get('app.use_region')\n                        ? this._org.buildingsForRegion().map((_) => _.id)\n                        : [this._org.building.id]\n                    : filters.zones;\n            this._next_page.next(() =>\n                queryPagedBookings({\n                    period_start: getUnixTime(startOfDay(date)),\n                    period_end: getUnixTime(endOfDay(date)),\n                    type: 'desk',\n                    zones: zones.join(','),\n                    include_checked_out: true,\n                }).pipe(\n                    catchError((_) => of({ data: [], total: 0, next: null }))\n                )\n            );\n            this._call_next_page.next(`RESET_${Date.now()}`);\n        })\n    );\n\n    public readonly paged_bookings = combineLatest([\n        this._next_page,\n        this._call_next_page,\n    ]).pipe(\n        distinctUntilChanged((a, b) => a[1] === b[1]),\n        switchMap(([next_page, action]) => {\n            this._loading.next(true);\n            if (!next_page) {\n                return of({\n                    data: [],\n                    total: 0,\n                    next: null,\n                    reset: action.includes('RESET'),\n                });\n            }\n            // If reset is true, start over\n            if (action.includes('RESET')) {\n                return next_page().pipe(\n                    map((data: any) => ({ ...data, reset: true })),\n                    catchError((_) => of({ data: [], total: 0, next: null }))\n                );\n            }\n            return next_page().pipe(\n                map((data: any) => ({ ...data, reset: false })),\n                catchError((_) => of({ data: [], total: 0, next: null }))\n            );\n        }),\n        scan(\n            (acc, { data, total, next, reset }) => {\n                const list = data;\n                this._next_page.next(next); // Set the next page function\n                if (reset) return { list, total }; // Reset the items array\n                return {\n                    list: [...acc.list, ...list],\n                    total,\n                };\n            },\n            { list: [], total: 0 }\n        ),\n        tap((_) => this._loading.next(false)),\n        shareReplay(1)\n    );\n\n    public readonly has_more_pages = this.paged_bookings.pipe(\n        map((_) => _.list.length < _.total)\n    );\n    public readonly bookings = this.paged_bookings.pipe(map((i) => i.list));\n\n    public nextPage() {\n        this._call_next_page.next(`NEXT_${Date.now()}`);\n    }\n\n    constructor(\n        private _org: OrganisationService,\n        private _dialog: MatDialog,\n        private _settings: SettingsService\n    ) {\n        super();\n        this.setup_paging.subscribe();\n    }\n\n    public setFilters(filters: DeskFilters) {\n        if (filters.zones?.includes('All')) {\n            filters.zones = [\n                'All',\n                ...this._org\n                    .levelsForBuilding(this._org.building)\n                    .map((lvl) => lvl.id),\n            ];\n        } else if (\n            filters.zones &&\n            this._filters.getValue()?.zones?.includes('All')\n        ) {\n            filters.zones = [];\n        }\n        this._filters.next({ ...this._filters.getValue(), ...filters });\n    }\n\n    public refresh() {\n        this._loading.next(true);\n        this.timeout('poll', () => this.setFilters(this._filters.getValue()));\n    }\n\n    public addDesks(list: Desk[]) {\n        this._new_desks.next(this._new_desks.getValue().concat(list));\n    }\n\n    public removeNewDesk(desk: Desk) {\n        this._filters.next(this._filters.getValue());\n        this._new_desks.next(\n            this._new_desks.getValue().filter((d) => d.id !== desk.id)\n        );\n    }\n\n    public clearNewDesks() {\n        this._filters.next(this._filters.getValue());\n        this._new_desks.next([]);\n    }\n\n    public async checkinDesk(desk: Booking, state: boolean = true) {\n        const status: any = await checkinBooking(desk.id, state ?? true)\n            .toPromise()\n            .catch((_) => ({ failed: true, error: _ }));\n        if (status.failed) {\n            notifyError(\n                status.error\n                    ? `Error: ${status.error}`\n                    : `Error checking ${state ? 'in' : 'out'} desk booking`\n            );\n            throw status.error;\n        }\n        notifySuccess(`Checked ${state ? 'in' : 'out'} ${desk.user_name}.`);\n    }\n\n    public async approveDesk(desk: Booking) {\n        const success = await approveBooking(desk.id)\n            .toPromise()\n            .catch((_) => 'failed');\n        if (success === 'failed') {\n            return notifyError('Error approving in desk booking');\n        }\n        notifySuccess(\n            `Approved desk booking for ${desk.user_name} on ${format(\n                desk.date,\n                'MMM do'\n            )}.`\n        );\n        (desk as any).approved = true;\n        (desk as any).rejected = false;\n    }\n\n    public async rejectDesk(desk: Booking) {\n        const success = await rejectBooking(desk.id)\n            .toPromise()\n            .catch((_) => 'failed');\n        if (success === 'failed') {\n            return notifyError('Error rejecting in desk booking');\n        }\n        notifySuccess(\n            `Rejected desk booking for ${desk.user_name} on ${format(\n                desk.date,\n                'MMM do'\n            )}.`\n        );\n        (desk as any).approved = false;\n        (desk as any).rejected = true;\n    }\n\n    public async giveAccess(desk: Booking) {\n        const success = await saveBooking(\n            new Booking({ ...desk, access: true })\n        )\n            .toPromise()\n            .catch((_) => 'failed');\n        if (success === 'failed')\n            return notifyError('Error giving building access booking host');\n        notifySuccess(\n            `Successfully gave building access to ${desk.user_name} for desk booking.`\n        );\n        this._desk_bookings = [...this._desk_bookings, success] as any;\n    }\n\n    public async rejectAllDesks() {\n        const list = this._desk_bookings || [];\n        if (list.length <= 0)\n            return notifyInfo('No desks to reject for the selected date');\n        const resp = await openConfirmModal(\n            {\n                title: 'Cancel all desk bookings',\n                content:\n                    'Are you sure you want to cancel all bookings for the selected date?',\n                icon: {\n                    type: 'icon',\n                    class: 'material-icons',\n                    content: 'delete',\n                },\n            },\n            this._dialog\n        );\n        if (resp.reason !== 'done') return;\n        resp.loading('Rejecting all desks for selected date...');\n        await Promise.all(\n            list.map((desk) => rejectBooking(desk.id).toPromise())\n        );\n        notifySuccess(\n            'Successfully rejected all desk bookings for selected date.'\n        );\n        resp.close();\n    }\n}\n"],"names":["MatDialog","listChildMetadata","showMetadata","BehaviorSubject","combineLatest","of","Subject","catchError","debounceTime","distinctUntilChanged","map","scan","shareReplay","switchMap","tap","endOfDay","format","getUnixTime","startOfDay","approveBooking","Booking","checkinBooking","queryPagedBookings","rejectBooking","saveBooking","AsyncHandler","notifyError","notifyInfo","notifySuccess","openConfirmModal","SettingsService","Desk","OrganisationService","generateQRCode","addQRCodeToBooking","booking","extension_data","checkin_qr_code","encodeURIComponent","asset_id","DesksStateService","new_desk_count","_new_desks","getValue","length","nextPage","_call_next_page","next","Date","now","constructor","_org","_dialog","_settings","_filters","_desk_bookings","_loading","new_desks","asObservable","loading","filters","desks","pipe","zones","includes","m","details","Array","_","building","id","name","i","metadata","reduce","c","list","sort","a","b","localeCompare","qr_code","_next_page","_all_zones_keys","setup_paging","initialised","loaded","date","some","z","get","buildingsForRegion","period_start","period_end","type","join","include_checked_out","data","total","paged_bookings","next_page","action","reset","acc","has_more_pages","bookings","subscribe","setFilters","levelsForBuilding","lvl","refresh","timeout","addDesks","concat","removeNewDesk","desk","filter","d","clearNewDesks","checkinDesk","state","_asyncToGenerator","status","toPromise","catch","failed","error","user_name","approveDesk","success","approved","rejected","rejectDesk","giveAccess","_this","access","rejectAllDesks","_this2","resp","title","content","icon","class","reason","Promise","all","close","i0","ɵɵinject","i1","i2","i3","_2","factory","ɵfac","providedIn"],"sourceRoot":"webpack:///","x_google_ignoreList":[]}